<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hue XY Builder</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
      }
      #colorPicker {
        width: 100px;
        height: 50px;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h3>Hue XY Picker</h3>

    <input type="color" id="colorPicker" value="#ff0000" />
    <br /><br />

    Brightness:
    <input type="range" id="brightness" min="0" max="254" value="254" />
    <span id="bval">254</span>

    <br /><br />

    <button onclick="applyPreset('energize')">Energize</button>
    <button onclick="applyPreset('read')">Read</button>
    <button onclick="applyPreset('santorini')">Santorini</button>
    <button onclick="applyPreset('amsterdam')">Amsterdam</button>

    <br /><br />
    <button onclick="sendPower(false)">Power OFF</button>

    <br /><br />

    <textarea id="output" rows="4" cols="90"></textarea>
    <br /><br />
    <button onclick="copyToClipboard()">Copy DATA</button>
    <span id="copyStatus"></span>

    <script>
      const colorPicker = document.getElementById("colorPicker");
      const brightnessSlider = document.getElementById("brightness");
      const colorValue = document.getElementById("output");
      const brightnessValue = document.getElementById("bval");

      const PRESETS = {
        energize: [0x01, 0x01, 0x01, 0x02, 0x01, 0xfe, 0x03, 0x02, 0x9c, 0x00],
        read: [0x01, 0x01, 0x01, 0x02, 0x01, 0xfe, 0x03, 0x02, 0x5a, 0x01],
        santorini: [
          0x01, 0x01, 0x01, 0x02, 0x01, 0xca, 0x04, 0x04, 0x77, 0x77, 0x37,
          0x4b, 0x07, 0x13, 0x50, 0x00, 0x00, 0x00, 0x4f, 0x15, 0x54, 0x61,
          0x97, 0x6a, 0xe4, 0x87, 0x70, 0x9f, 0x88, 0x73, 0x29, 0x3a, 0x59,
          0x08, 0x01, 0xa0,
        ],
        amsterdam: [
          0x01, 0x01, 0x01, 0x02, 0x01, 0xca, 0x04, 0x04, 0x1e, 0x85, 0x85,
          0x6b, 0x07, 0x13, 0x50, 0x00, 0x00, 0x00, 0xf6, 0x28, 0x7b, 0x14,
          0x7a, 0x94, 0x8b, 0x54, 0xa2, 0x75, 0xa3, 0x70, 0x29, 0x3a, 0x59,
          0x08, 0x01, 0xa0,
        ],
      };

      let currentX = 0;
      let currentY = 0;

      // Hex color string to Hue CIE xy (Wide RGB D65 matrix)
      function updateXyFromColor(hex) {
        let r = parseInt(hex.substring(1, 3), 16) / 255;
        let g = parseInt(hex.substring(3, 5), 16) / 255;
        let b = parseInt(hex.substring(5, 7), 16) / 255;
        r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
        g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
        b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;
        const X = r * 0.664511 + g * 0.154324 + b * 0.162028;
        const Y = r * 0.283881 + g * 0.668433 + b * 0.047685;
        const Z = r * 0.000088 + g * 0.07231 + b * 0.986039;
        const sum = X + Y + Z;
        const cx = sum === 0 ? 0.3127 : X / sum;
        const cy = sum === 0 ? 0.329 : Y / sum;
        currentX = Math.round(cx * 65535);
        currentY = Math.round(cy * 65535);
      }

      function buildPacket(x16, y16, brightness) {
        return [
          0x01,
          0x01,
          0x01,
          0x02,
          0x01,
          brightness,
          0x04,
          0x04,
          x16 & 0xff,
          (x16 >> 8) & 0xff,
          y16 & 0xff,
          (y16 >> 8) & 0xff,
        ];
      }

      function parseHexPacket(value) {
        const cleaned = value.toLowerCase().replace(/0x/g, "").replace(/\s+/g, "");
        if (!cleaned || cleaned.length % 2 !== 0) return null;
        if (!/^[0-9a-f]+$/.test(cleaned)) return null;

        const data = [];
        for (let i = 0; i < cleaned.length; i += 2) {
          data.push(parseInt(cleaned.slice(i, i + 2), 16));
        }
        return data;
      }

      function updatePacketFromColor() {
        const brightness = parseInt(brightnessSlider.value);
        brightnessValue.textContent = brightness;
        sendColor(buildPacket(currentX, currentY, brightness));
      }

      function updatePacketBrightnessOnly() {
        const brightness = parseInt(brightnessSlider.value);
        brightnessValue.textContent = brightness;

        const dataFromPage = parseHexPacket(colorValue.value);
        const data =
          dataFromPage && dataFromPage.length > 5
            ? dataFromPage
            : buildPacket(currentX, currentY, brightness);
        data[5] = brightness;

        sendColor(data);
      }

      function applyPreset(name) {
        const brightness = parseInt(brightnessSlider.value);
        brightnessValue.textContent = brightness;

        // Clone preset
        const data = [...PRESETS[name]];

        // Replace brightness byte (index 5)
        data[5] = brightness;

        sendColor(data);
      }

      function sendColor(data) {
        const hexString = data
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");

        fetch(`http://localhost:8000/send?data=${hexString}`).then(() =>
          console.log("Sent to BLE"),
        );

        colorValue.value = hexString;
      }

      brightnessSlider.addEventListener("input", updatePacketBrightnessOnly);

      function onColorChange(e) {
        localStorage.setItem("hueColor", e.target.value);
        console.log(e.target.value);
        updateXyFromColor(e.target.value);
        updatePacketFromColor();
      }

      colorPicker.addEventListener("input", onColorChange);
      colorPicker.addEventListener("change", onColorChange);

      function copyToClipboard() {
        const text = document.getElementById("output").value;

        navigator.clipboard.writeText(text).then(() => {
          document.getElementById("copyStatus").textContent = " âœ” Copied!";
          setTimeout(() => {
            document.getElementById("copyStatus").textContent = "";
          }, 1000);
        });
      }

      function sendPower(state) {
        fetch(`http://localhost:8000/power?state=${state ? "on" : "off"}`).then(
          () => console.log("Power command sent"),
        );
      }

      // Initialize from saved color or default
      const savedColor = localStorage.getItem("hueColor");
      if (savedColor) colorPicker.value = savedColor;
      updateXyFromColor(colorPicker.value);
      updatePacketFromColor();
    </script>
  </body>
</html>
